version: '3.8'

services:
#  softwarebackend:
#    build: .
#    container_name: softwarebackend
#    ports:
#      - "8000:8000"
#    env_file:
#      - .env
#    depends_on:
#      kafka:
#        condition: service_healthy
#    networks:
#      - backend-network
#    restart: on-failure
  kafka:
    image: bitnami/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    networks:
      - backend-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    environment:
      # Enable KRaft mode
      KAFKA_ENABLE_KRAFT: "yes"

      # Node and roles
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: controller,broker

      # Listeners
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093

      # Topic replication
      KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

      # Allow PLAINTEXT for local dev
      ALLOW_PLAINTEXT_LISTENER: "yes"

networks:
  backend-network:
    driver: bridge
